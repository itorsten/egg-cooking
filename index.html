<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Egg Cooking Simulator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0;
      font-family: 'Inter', 'Roboto', 'Open Sans', sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: #fff;
    }
    header {
      text-align: center;
      padding: 20px;
    }
    header h1 {
      margin: 0;
      font-size: 2.2em;
    }
    header p {
      margin: 5px 0 0 0;
      font-size: 1em;
    }
    main {
      flex: 1;
      padding: 0 20px 20px 20px;
      align-self: center;
    }
    #layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 938px;
      width: 80vw;
    }
    .input-panel {
      max-width: 768px;
      width: 100%;
    }
    .input-panel label {
      display: block;
      margin-top: 10px;
      font-weight: 500;
    }
    .input-panel input,
    .input-panel select,
    .input-panel textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
      font-size: 1em;
      margin-top: 4px;
    }
    .input-panel textarea {
      resize: vertical;
    }
    .hint {
      font-size: 0.85em;
      color: #666;
    }
    .run-btn-wrapper {
      text-align: right;
      margin-top: 15px;
    }
    .run-btn {
      background: #f5ba31;
      border: none;
      padding: 10px 20px;
      font-size: 1.1em;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    .run-btn:active {
      transform: scale(0.98);
    }
    .output-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }
    .output-panel canvas {
      width: 100%;
      display: none;
    }
    footer {
      margin-top: auto;
      font-size: 0.85em;
      text-align: center;
      color: #555;
      padding: 10px 0;
    }
    @media (min-width: 768px) {
      #layout {
        flex-direction: row;
        align-items: flex-start;
      }
      .input-panel {
        width: 35%
      }
      .output-panel {
        width: 65%;
      }
      .output-panel canvas {
        flex: 1;
      }
    }
    @media (max-width: 767px) {
      #layout {
        flex-direction: column;
        align-items: flex-start;
      }
      .output-panel {
        width: 100%;
      }
      .input-panel {
        width: 100%
      }
      .run-btn-wrapper {
        text-align: initial;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ü•ö Egg Cooking Simulator</h1>
    <p>Experiment with cooking time and temperature for the perfect egg</p>
  </header>
  <main>
    <div id="layout">
      <div class="input-panel">
        <label for="profileType">Preset</label>
        <select id="profileType">
          <option value="hard">Hard boiled</option>
          <option value="soft">Soft boiled</option>
          <option value="sousvide">Sous vide</option>
          <option value="periodic">Periodic</option>
          <option value="coldstart">Start in cold water</option>
          <option value="sousvidefinish">Sous vide + finishing boil</option>
        </select>
        <label for="totalTime" id="totalTimeLabel">‚è±Ô∏è Total time time (minutes)</label>
        <input type="number" id="totalTime" value="10" step="1" placeholder="Enter cooking time in minutes." min="1" aria-label="total cooking time">
        <label for="waterTemp" id="waterTempLabel">üå°Ô∏è Water temperature (¬∞C)</label>
        <input type="number" id="waterTemp" value="100" step="1" min="0" max="100" aria-label="water temperature">
        <div id="scheduleInput" style="display:none;">
          <label for="scheduleData">Schedule (time&nbsp;[s],temperature&nbsp;[¬∞C] pairs)</label>
          <textarea id="scheduleData" rows="4" placeholder="60 ‚Äì 100"></textarea>
          <div class="hint">Enter one pair per line, comma separated, e.g. <code>60,100</code></div>
        </div>
        <div class="run-btn-wrapper">
          <button id="runBtn" class="run-btn">Run simulation</button>
        </div>
      </div>
      <div class="output-panel">
        <canvas id="tempChart"></canvas>
        <canvas id="cookChart"></canvas>
      </div>
    </div>
  </main>
  <footer>
    For details, see <a href="https://github.com/itorsten/egg-cooking" target="_blank">github.com/itorsten/egg-cooking</a>.<br />
    &copy; 2025 Ivar Torstensson
  </footer>
  <script>
// Switch between constant and schedule inputs
const profileType = document.getElementById('profileType');
const waterTemp = document.getElementById('waterTemp');
const totalTime = document.getElementById('totalTime');
const scheduleInput = document.getElementById('scheduleInput');
const scheduleData = document.getElementById('scheduleData');

profileType.addEventListener('change', function () {
  switch (profileType.value) {
    case 'hard':
      waterTemp.value = 100;
      totalTime.value = 12;
      waterTemp.style.display = '';
      document.getElementById('waterTempLabel').style.display = '';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleInput.style.display = 'none';
      break;
    case 'soft':
      waterTemp.value = 100;
      totalTime.value = 6;
      waterTemp.style.display = '';
      document.getElementById('waterTempLabel').style.display = '';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleInput.style.display = 'none';
      break;
    case 'sousvide':
      waterTemp.value = 65;
      totalTime.value = 60;
      waterTemp.style.display = '';
      document.getElementById('waterTempLabel').style.display = '';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleInput.style.display = 'none';
      break;
    case 'periodic':
      scheduleInput.style.display = '';
      totalTime.value = 32;
      waterTemp.style.display = 'none';
      document.getElementById('waterTempLabel').style.display = 'none';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleData.value = Array.from({length: 1920/120+1}, (_,i)=>[`${i*120+1},${i%2?30:100}`, `${i*120+120},${i%2?30:100}`]).flat().join("\n");
      break;
    case 'coldstart':
      scheduleInput.style.display = '';
      totalTime.value = 10;
      waterTemp.style.display = 'none';
      document.getElementById('waterTempLabel').style.display = 'none';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleData.value = "0,10\n120,100\n480,100\n481,10\n600,10";
      break;
    case 'sousvidefinish':
      scheduleInput.style.display = '';
      totalTime.value = 34;
      waterTemp.style.display = 'none';
      document.getElementById('waterTempLabel').style.display = 'none';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleData.value = "0,65\n1800,65\n1860,100\n1920,100\n1940,10";
      break;
  }
});

// Parse schedule textarea into sorted time-temperature objects
function parseSchedule(text) {
  const lines = text.trim().split(/\n+/);
  const schedule = [];
  for (const line of lines) {
    const [t, temp] = line.split(',').map(Number);
    if (!isNaN(t) && !isNaN(temp)) {
      schedule.push({ t, temp });
    }
  }
  schedule.sort((a, b) => a.t - b.t);
  return schedule;
}

// Determine water temperature at time t
function getWaterTemp(t, profile) {
  if (profile.type === 'constant') return profile.temp;
  const sched = profile.schedule;
  if (t <= sched[0].t) return sched[0].temp;
  for (let i = 0; i < sched.length - 1; i++) {
    const a = sched[i], b = sched[i + 1];
    if (t >= a.t && t <= b.t) {
      const f = (t - a.t) / (b.t - a.t);
      return a.temp + f * (b.temp - a.temp);
    }
  }
  return sched[sched.length - 1].temp;
}

// Run ODE simulation and plot results
function runSimulation() {
  const totalTime = Number(document.getElementById('totalTime').value) * 60;
  const dt = 0.1; // Solver time step in seconds
  const steps = Math.round(totalTime / dt);
  const outputTimestep = 15; // Seconds between output points
  const outputDecimation = Math.max(1, Math.round(outputTimestep / dt));

  // Build water temperature profile
  const type = profileType.value;
  let profile;
  if (type === 'hard' || type === 'soft' || type === 'sousvide') {
    profile = { type: 'constant', temp: Number(waterTemp.value) };
  } else if (type === 'periodic' || type === 'coldstart' || type === 'sousvidefinish') {
    profile = { type: 'schedule', schedule: parseSchedule(scheduleData.value) };
  }

  // Parameters
  const C_albumen = 3800;      // heat capacity of albumen [J/(kg*K)]
  const C_yolk = 3120;         // heat capacity of yolk [J/(kg*K)]
  const k_albumenyolk = 0.35;  // conductance albumen-yolk [W/K]
  const h_shell = 500;         // convective heat transfer coefficient [W/(m^2*K)]
  const A_shell = 0.003;       // eggshell surface area [m^2]
  const mass_albumen = 0.025;  // mass of albumen in egg [kg]
  const mass_yolk = 0.02;      // mass of yolk in egg [kg]

  const k0_albumen = 4.85e60;  // pre-exponential factor for albumen denaturation [s^-1]
  const Ea_albumen = 4.185e5;  // activation energy for albumen [J/mol]
  const k0_yolk = 2.72e50;     // pre-exponential factor for yolk denaturation [s^-1]
  const Ea_yolk = 3.443e5;     // activation energy for yolk [J/mol]
  const R = 8.314;             // universal gas constant [J/(mol*K)]

  // Initial states
  let T_albumen = 20 + 273.15;   // temperature of the albumen [K]
  let T_yolk = 20 + 273.15;      // temperature of the yolk [K]
  let X_albumen = 0;             // albumen cooking degree [fraction]
  let X_yolk = 0;                // yolk cooking degree [fraction]

  const time = [], uTemp = [], yTemp = [], aTemp = [], yCook = [], aCook = [];
  for (let i = 0; i <= steps; i++) {
    // Get time and inputs
    const t = i * dt;
    const T_env = getWaterTemp(t, profile) + 273.15; // temperature of surrounding water [K]

    // Store outputs
    if (i % outputDecimation === 0 || i === steps) {
      time.push(t / 60); // Convert to minutes for display
      uTemp.push(T_env - 273.15); // Convert K to ¬∞C for display
      yTemp.push(T_yolk - 273.15);
      aTemp.push(T_albumen - 273.15);
      yCook.push(X_yolk);
      aCook.push(X_albumen);
    }

    // Update model...

    // Heat flows
    const Q_env_albumen = h_shell * A_shell * (T_env - T_albumen); // environment to albumen [W]
    const Q_albumen_yolk = k_albumenyolk * (T_albumen - T_yolk);   // albumen to yolk [W]

    // Energy balances
    const dT_albumen = (Q_env_albumen - Q_albumen_yolk) / (mass_albumen * C_albumen);
    const dT_yolk = Q_albumen_yolk / (mass_yolk * C_yolk);

    // Denaturation kinetics
    const dX_albumen = (1 - X_albumen) * Math.exp(-Ea_albumen / (R * T_albumen)) * k0_albumen;
    const dX_yolk = (1 - X_yolk) * Math.exp(-Ea_yolk / (R * T_yolk)) * k0_yolk;

    // Euler integration
    T_albumen += dt * dT_albumen;
    T_yolk    += dt * dT_yolk;
    X_albumen += dt * dX_albumen;
    X_yolk    += dt * dX_yolk;

    // Clamp cooking degrees between 0 and 1
    X_albumen = Math.min(X_albumen, 1);
    X_yolk = Math.min(X_yolk, 1);
  }

  plotResults(time, uTemp, yTemp, aTemp, yCook, aCook);
}

document.getElementById('runBtn').addEventListener('click', runSimulation);

let tempChart, cookChart;
function plotResults(time, uTemp, yTemp, aTemp, yCook, aCook) {
  if (tempChart) tempChart.destroy();
  if (cookChart) cookChart.destroy();

  const ctxT = document.getElementById('tempChart');
  tempChart = new Chart(ctxT, {
    type: 'line',
    data: {
      labels: time,
      datasets: [
        { label: 'Water', data: uTemp, borderColor: 'blue', fill: false },
        { label: 'Yolk', data: yTemp, borderColor: 'orange', fill: false },
        { label: 'Albumen', data: aTemp, borderColor: 'grey', fill: false }
      ]
    },
    options: {
      maintainAspectRatio: true,
      scales: {
        x: { title: { display: true, text: 'Time (min)' } },
        y: { title: { display: true, text: 'Temp (¬∞C)' } }
      }
    }
  });

  const ctxC = document.getElementById('cookChart');
  cookChart = new Chart(ctxC, {
    type: 'line',
    data: {
      labels: time,
      datasets: [
        { label: 'Yolk', data: yCook, borderColor: 'orange', fill: false },
        { label: 'Albumen', data: aCook, borderColor: 'grey', fill: false }
      ]
    },
    options: {
      maintainAspectRatio: true,
      scales: {
        x: { title: { display: true, text: 'Time (min)' } },
        y: { title: { display: true, text: 'Cooking Degree' } }
      }
    }
  });
}
  </script>
</body>
</html>
