<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Egg Cooking Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    canvas { max-width: 600px; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Egg Cooking Simulator</h1>
  <div>
    <label for="profileType">Temperature profile preset:</label>
    <select id="profileType">
      <option value="hard">Hard boiled</option>
      <option value="soft">Soft boiled</option>
      <option value="sousvide">Sous vide</option>
      <option value="periodic">Periodic</option>
      <option value="coldstart">Start in cold water</option>
      <option value="sousvidefinish">Sous vide + finishing boil</option>
    </select>
    <br>
    <label for="waterTemp" id="waterTempLabel">Water temperature (째C):</label>
    <input type="number" id="waterTemp" value="100" step="1">
    <br>
    <label for="totalTime" id="totalTimeLabel">Total time (min):</label>
    <input type="number" id="totalTime" value="10" step="1">
    <br>
    <div id="scheduleInput" style="display:none;">
      <label for="scheduleData">Schedule (time [s],temperature [째C] pairs):</label>
      <textarea id="scheduleData" rows="3">0,20
2,100
10,100</textarea>
    </div>
  </div>
  <button id="runBtn">Run Simulation</button>
  <canvas id="tempChart"></canvas>
  <canvas id="cookChart"></canvas>
  <footer style="margin-top: 20px; font-size: 0.95em; color: #555;">
    For details, see <a href="https://github.com/itorsten/egg-cooking" target="_blank">github.com/itorsten/egg-cooking</a>.<br>
    &copy; 2025 Ivar Torstensson
  </footer>
<script>
// Switch between constant and schedule inputs
const profileType = document.getElementById('profileType');
const waterTemp = document.getElementById('waterTemp');
const totalTime = document.getElementById('totalTime');
const scheduleInput = document.getElementById('scheduleInput');
const scheduleData = document.getElementById('scheduleData');

profileType.addEventListener('change', function () {
  switch (profileType.value) {
    case 'hard':
      waterTemp.value = 100;
      totalTime.value = 12;
      waterTemp.style.display = '';
      document.getElementById('waterTempLabel').style.display = '';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleInput.style.display = 'none';
      break;
    case 'soft':
      waterTemp.value = 100;
      totalTime.value = 6;
      waterTemp.style.display = '';
      document.getElementById('waterTempLabel').style.display = '';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleInput.style.display = 'none';
      break;
    case 'sousvide':
      waterTemp.value = 65;
      totalTime.value = 60;
      waterTemp.style.display = '';
      document.getElementById('waterTempLabel').style.display = '';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleInput.style.display = 'none';
      break;
    case 'periodic':
      scheduleInput.style.display = '';
      totalTime.value = 32;
      waterTemp.style.display = 'none';
      document.getElementById('waterTempLabel').style.display = 'none';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleData.value = Array.from({length: 1920/120+1}, (_,i)=>[`${i*120+1},${i%2?30:100}`, `${i*120+120},${i%2?30:100}`]).flat().join("\n");
      break;
    case 'coldstart':
      scheduleInput.style.display = '';
      totalTime.value = 10;
      waterTemp.style.display = 'none';
      document.getElementById('waterTempLabel').style.display = 'none';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleData.value = "0,10\n120,100\n480,100\n481,10\n600,10";
      break;
    case 'sousvidefinish':
      scheduleInput.style.display = '';
      totalTime.value = 34;
      waterTemp.style.display = 'none';
      document.getElementById('waterTempLabel').style.display = 'none';
      totalTime.style.display = '';
      document.getElementById('totalTimeLabel').style.display = '';
      scheduleData.value = "0,65\n1800,65\n1860,100\n1920,100\n1940,10";
      break;
  }
});

// Parse schedule textarea into sorted time-temperature objects
function parseSchedule(text) {
  const lines = text.trim().split(/\n+/);
  const schedule = [];
  for (const line of lines) {
    const [t, temp] = line.split(',').map(Number);
    if (!isNaN(t) && !isNaN(temp)) {
      schedule.push({ t, temp });
    }
  }
  schedule.sort((a, b) => a.t - b.t);
  return schedule;
}

// Determine water temperature at time t
function getWaterTemp(t, profile) {
  if (profile.type === 'constant') return profile.temp;
  const sched = profile.schedule;
  if (t <= sched[0].t) return sched[0].temp;
  for (let i = 0; i < sched.length - 1; i++) {
    const a = sched[i], b = sched[i + 1];
    if (t >= a.t && t <= b.t) {
      const f = (t - a.t) / (b.t - a.t);
      return a.temp + f * (b.temp - a.temp);
    }
  }
  return sched[sched.length - 1].temp;
}

// Run ODE simulation and plot results
function runSimulation() {
  const totalTime = Number(document.getElementById('totalTime').value) * 60;
  const dt = 0.1; // Solver time step in seconds
  const steps = Math.round(totalTime / dt);
  const outputTimestep = 15; // Seconds between output points
  const outputDecimation = Math.max(1, Math.round(outputTimestep / dt));

  // Build water temperature profile
  const type = profileType.value;
  let profile;
  if (type === 'hard' || type === 'soft' || type === 'sousvide') {
    profile = { type: 'constant', temp: Number(waterTemp.value) };
  } else if (type === 'periodic' || type === 'coldstart' || type === 'sousvidefinish') {
        profile = { type: 'schedule', schedule: parseSchedule(document.getElementById('scheduleData').value) };

    }

  // Parameters
  const C_albumen = 3800;      // heat capacity of albumen [J/(kg*K)]
  const C_yolk = 3120;         // heat capacity of yolk [J/(kg*K)]
  const k_albumenyolk = 0.35;   // conductance albumen-yolk [W/K]
  const h_shell = 500;         // convective heat transfer coefficient [W/(m^2*K)]
  const A_shell = 0.003;       // eggshell surface area [m^2]
  const mass_albumen = 0.025;   // mass of albumen in egg [kg]
  const mass_yolk = 0.02;     // mass of yolk in egg [kg]
  
  const k0_albumen = 4.85e60;  // pre-exponential factor for albumen denaturation [s^-1]
  const Ea_albumen = 4.185e5;  // activation energy for albumen [J/mol]
  const k0_yolk = 2.72e50;     // pre-exponential factor for yolk denaturation [s^-1]
  const Ea_yolk = 3.443e5;     // activation energy for yolk [J/mol]
  const R = 8.314;             // universal gas constant [J/(mol*K)]

  // Initial states
  let T_albumen = 20+273.15;   // temperature of the albumen [K]
  let T_yolk = 20+273.15;      // temperature of the yolk [K]
  let X_albumen = 0;           // albumen cooking degree [fraction]
  let X_yolk = 0;              // yolk cooking degree [fraction]

  const time = [], uTemp = [], yTemp = [], aTemp = [], yCook = [], aCook = [];
  for (let i = 0; i <= steps; i++) {
    // Get time and inputs
    const t = i * dt;
    const T_env = getWaterTemp(t, profile) + 273.15; // temperature of surrounding water [K]

    // Store outputs
    if (i % outputDecimation === 0 || i === steps) {
      time.push(t/60); // Convert to minutes for display
      uTemp.push(T_env - 273.15); // Convert K to 째C for display
      yTemp.push(T_yolk - 273.15);
      aTemp.push(T_albumen - 273.15);
      yCook.push(X_yolk);
      aCook.push(X_albumen);
    }

    // Update model...

    // Heat flows
    const Q_env_albumen = h_shell * A_shell * (T_env - T_albumen); // environment to albumen [W]
    const Q_albumen_yolk = k_albumenyolk * (T_albumen - T_yolk);   // albumen to yolk [W]

    // Energy balances
    const dT_albumen = (Q_env_albumen - Q_albumen_yolk) / (mass_albumen * C_albumen);
    const dT_yolk = Q_albumen_yolk / (mass_yolk * C_yolk);

    // Denaturation kinetics
    const dX_albumen = (1 - X_albumen) * Math.exp(-Ea_albumen / (R * T_albumen)) * k0_albumen;
    const dX_yolk = (1 - X_yolk) * Math.exp(-Ea_yolk / (R * T_yolk)) * k0_yolk;

    // Euler integration
    T_albumen += dt * dT_albumen;
    T_yolk    += dt * dT_yolk;
    X_albumen += dt * dX_albumen;
    X_yolk    += dt * dX_yolk;

    // Clamp cooking degrees between 0 and 1
    X_albumen = Math.min(X_albumen, 1);
    X_yolk = Math.min(X_yolk, 1);
  }

  plotResults(time, uTemp, yTemp, aTemp, yCook, aCook);
}

document.getElementById('runBtn').addEventListener('click', runSimulation);

let tempChart, cookChart;
function plotResults(time, uTemp, yTemp, aTemp, yCook, aCook) {
  if (tempChart) tempChart.destroy();
  if (cookChart) cookChart.destroy();

  const ctxT = document.getElementById('tempChart');
  tempChart = new Chart(ctxT, {
    type: 'line',
    data: {
      labels: time,
      datasets: [
        { label: 'Water', data: uTemp, borderColor: 'blue', fill: false },
        { label: 'Yolk', data: yTemp, borderColor: 'orange', fill: false },
        { label: 'Albumen', data: aTemp, borderColor: 'grey', fill: false }
      ]
    },
    options: {
      scales: {
        x: { title: { display: true, text: 'Time (min)' } },
        y: { title: { display: true, text: 'Temp (째C)' } }
      }
    }
  });

  const ctxC = document.getElementById('cookChart');
  cookChart = new Chart(ctxC, {
    type: 'line',
    data: {
      labels: time,
      datasets: [
        { label: 'Yolk', data: yCook, borderColor: 'orange', fill: false },
        { label: 'Albumen', data: aCook, borderColor: 'grey', fill: false }
      ]
    },
    options: {
      scales: {
        x: { title: { display: true, text: 'Time (min)' } },
        y: { title: { display: true, text: 'Cooking Degree' } }
      }
    }
  });
}
</script>
</body>
</html>
